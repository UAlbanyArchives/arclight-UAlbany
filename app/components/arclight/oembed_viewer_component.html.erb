
<% if @resource.respond_to?(:action) and @resource.action.downcase == "embed" %>
  <div class="mirador-container" id="mirador-container"></div>
<% elsif @resource.respond_to?(:action) and @resource.action.downcase == "link" %>
  <a href="<%= @resource.href %>"><%= @resource.label %></a>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const miradorContainer = document.getElementById('mirador-container');

    const viewer = Mirador.viewer({
      id: 'mirador-container',
      windows: [{
        loadedManifest: '<%= @resource.href %>',
        allowFullscreen: true,
        defaultSideBarPanel: 'none',
        sideBarOpenByDefault: false,
        thumbnailNavigationPosition: 'far-bottom',
      }],
      workspaceControlPanel: { enabled: false },
      window: {
        allowClose: false
      }
    });

    // Fullscreen toggle using Mirador's button
    miradorContainer.addEventListener('click', (event) => {
      const fullscreenBtn = event.target.closest('.mirador-fullscreen-button');
      if (!fullscreenBtn) return;

      event.preventDefault();

      if (!document.fullscreenElement) {
        if (miradorContainer.requestFullscreen) {
          miradorContainer.requestFullscreen();
        } else if (miradorContainer.webkitRequestFullscreen) {
          miradorContainer.webkitRequestFullscreen();
        } else if (miradorContainer.msRequestFullscreen) {
          miradorContainer.msRequestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    });

    // Zoom behavior on fullscreen change
    document.addEventListener('fullscreenchange', () => {
      const state = viewer.store.getState();
      const windowIds = Object.keys(state.windows || {});
      if (windowIds.length === 0) return;
      const windowId = windowIds[0];

      if (document.fullscreenElement) {
        // Entered fullscreen: zoom to 100%
        viewer.store.dispatch({
          type: 'mirador/UPDATE_VIEWPORT',
          windowId,
          payload: { zoom: 1 }
        });
      } else {
        // Exited fullscreen: fit to width
        viewer.store.dispatch({
          type: 'mirador/FIT_TO',
          windowId,
          payload: { mode: 'width' }
        });
      }
    });
  });
</script>
