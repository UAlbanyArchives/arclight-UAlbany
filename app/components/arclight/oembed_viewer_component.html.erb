
<% if @resource.respond_to?(:action) and @resource.action.downcase == "embed" %>
  <div class="mirador-container mb-3" id="mirador-container"></div>
  <div class="mt-2">
    <a href="<%= @resource.href.sub('manifest.json', 'content.txt') %>" class="btn btn-outline-secondary btn-sm" download>
      <i class="fas fa-file-alt"></i> Download Transcript
    </a>
  </div>
<% elsif @resource.respond_to?(:action) and @resource.action.downcase == "link" %>
  <a href="<%= @resource.href %>"><%= @resource.label %></a>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const miradorContainer = document.getElementById('mirador-container');
    const isMobile = window.innerWidth <= 768;
    const query = window.initialSearchQuery;
    //console.log("Search query:", query);

    const viewer = Mirador.viewer({
      id: 'mirador-container',
      windows: [{
        loadedManifest: '<%= @resource.href %>',
        allowFullscreen: true,
        defaultSideBarPanel: 'none',
        sideBarOpenByDefault: false,
        thumbnailNavigationPosition: isMobile ? 'off' : 'far-right',
      }],
      requestConfig: {
        credentials: 'include',
      },
      workspaceControlPanel: { enabled: false },
      themes: {
        light: {
          palette: {
            primary: {
              main: '#46166B'
            }
          }
        }
      },
      window: {
        allowClose: false
      }
    });

    // Wait a bit before dispatching search â€” to ensure the window is fully registered
    setTimeout(() => {
      const state = viewer.store.getState();
      const windowIds = Object.keys(state.windows || {});
      if (windowIds.length === 0) return;

      const windowId = windowIds[0];

      const manifestUrl = '<%= @resource.href %>';

      const manifestPath = manifestUrl.replace(/\/manifest\.json$/, '');
      const pathParts = manifestPath.split('/').filter(Boolean);
      const searchServiceId = `https://media.archives.albany.edu/search/1/${pathParts[0]}/${pathParts[1]}`;

      if (query && query.trim().length > 0) {
        const searchId = `search-${Date.now()}`;
        viewer.store.dispatch({
          type: 'mirador/REQUEST_SEARCH',
          windowId,
          searchId,
          searchServiceId,
          query
        });
      }
    }, 300);

    // Fullscreen toggle using Mirador's button
    miradorContainer.addEventListener('click', (event) => {
      const fullscreenBtn = event.target.closest('.mirador-fullscreen-button');
      if (!fullscreenBtn) return;

      event.preventDefault();

      if (!document.fullscreenElement) {
        if (miradorContainer.requestFullscreen) {
          miradorContainer.requestFullscreen();
        } else if (miradorContainer.webkitRequestFullscreen) {
          miradorContainer.webkitRequestFullscreen();
        } else if (miradorContainer.msRequestFullscreen) {
          miradorContainer.msRequestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    });

    // Zoom behavior on fullscreen change
    document.addEventListener('fullscreenchange', () => {
      const state = viewer.store.getState();
      const windowIds = Object.keys(state.windows || {});
      if (windowIds.length === 0) return;
      const windowId = windowIds[0];

      if (document.fullscreenElement) {
        // Entered fullscreen: zoom to 100%
        viewer.store.dispatch({
          type: 'mirador/UPDATE_VIEWPORT',
          windowId,
          payload: { zoom: 1 }
        });
      } else {
        // Exited fullscreen: fit to width
        viewer.store.dispatch({
          type: 'mirador/FIT_TO',
          windowId,
          payload: { mode: 'width' }
        });
      }
    });
  });
</script>

